---
name: pr-comments-fix
description: PRレビューコメントを収集・分類し、順番に対応する
argument-hint: [<pr-number>]
---

# PR Comments Fix Command

PRレビューコメントを自動収集・分類し、1つずつ対応してコミットする。

## Instructions

### 1. 引数パースとPR番号取得

**PR番号の決定**:
- `$ARGUMENTS` に PR 番号が指定されている場合: その番号を使用
- 指定がない場合: `gh pr view --json number -q '.number'` で現在ブランチから自動検出
- PR が見つからない場合: エラーメッセージを表示して終了

### 2. レビューコメント収集

以下のコマンドでコメントを取得:

```bash
# PR の基本情報とレビュー情報
gh pr view <PR> --json reviews,comments,latestReviews,reviewDecision

# インラインコメント（ファイル・行番号付き）
gh api repos/{owner}/{repo}/pulls/<PR>/comments
```

### 3. コメント分類

コメントの**指摘内容の種類**に基づいて優先度を分類:

| Priority | カテゴリ | 指摘内容の例 |
|----------|---------|-------------|
| 1 | セキュリティ | 脆弱性、認証・認可の問題、機密情報の露出、入力検証の不備 |
| 2 | バグ・ロジックエラー | 実行時エラー、境界条件の漏れ、null/undefined の未処理、競合状態 |
| 3 | パフォーマンス | N+1クエリ、不要なループ、メモリリーク、非効率なアルゴリズム |
| 4 | 保守性・設計 | 責務の分離、重複コード、命名の改善、型定義の追加 |
| 5 | コードスタイル | フォーマット、lint指摘、コメント追加、import順序 |
| - | 質問・確認 | 実装意図の確認、仕様の質問（コード変更不要、返信のみ） |
| - | 対応不要 | LGTM、+1、承認コメント |

**分類の判断基準**:
- コメントが指摘している問題の**影響度**で判断
- 文面のキーワード（"must", "should" など）は参考程度
- 複数カテゴリに該当する場合は、より高い優先度を適用

### 4. フィルタリング

以下のコメントを除外:
- **解決済み**: `isResolved: true` のスレッド
- **自分のコメント**: `gh api user` で取得した自分のユーザー名と一致
- **対応不要カテゴリ**: LGTM、+1、承認コメントなど

### 5. 一覧表示

分類結果をサマリー表示:

```
## PR #<number> レビューコメント

### Priority 1: セキュリティ (X件)
- [ ] auth.ts:42 - "入力値のサニタイズが必要" (@reviewer)

### Priority 2: バグ・ロジックエラー (X件)
- [ ] handler.ts:78 - "null チェックが漏れている" (@reviewer)

### Priority 3: パフォーマンス (X件)
- [ ] query.ts:100 - "N+1 クエリになっている" (@reviewer)

### Priority 4: 保守性・設計 (X件)
- [ ] service.ts:55 - "この処理は別クラスに切り出すべき" (@reviewer)

### Priority 5: コードスタイル (X件)
- [ ] utils.ts:20 - "変数名を明確にしてほしい" (@reviewer)

### 質問・確認 (X件)
- [ ] config.ts:30 - "この設定値の意図は？" (@reviewer)

---
対応対象: X件 / 全体: Y件 (除外: Z件)
```

### 6. 順次対応（自動実行）

**常に自動実行モード**: 確認なしで順番に対応を開始

Priority 1 → 2 → 3 → 4 → 5 → 質問 の順で各コメントに対応:

**コード変更が必要な場合** (Priority 1-5):
1. 該当ファイルを読み込む
2. コメント内容に従ってコードを修正
3. 変更をステージング: `git add <file>`
4. コミット作成:
   ```bash
   git commit -m "fix(review): <コメント内容の要約>

   Addresses review comment by @<reviewer>
   - <変更内容の説明>

   Co-Authored-By: Claude <noreply@anthropic.com>"
   ```

**質問への回答が必要な場合** (質問・確認カテゴリ):
1. コードを確認して質問に回答
2. PR にコメントで返信:
   ```bash
   gh pr comment <PR> --body "<回答内容>"
   ```

### 7. 最終サマリー

すべての対応完了後、サマリーを表示:

```
## 対応完了

- コード修正: X件
- コミット作成: Y件
- 質問への返信: Z件

### 作成されたコミット:
- abc1234: fix(review): 〜を修正
- def5678: fix(review): 〜を追加
```

### 8. 自動プッシュ

変更がある場合、リモートにプッシュ:

```bash
git push origin HEAD
```

## 使用例

```bash
# 現在のブランチの PR コメントに対応
/pr-comments-fix

# PR 番号を指定して対応
/pr-comments-fix 123
```

## 注意事項

- **自動実行**: すべての対応は確認なしで自動実行される
- **コミット単位**: 各コメントへの対応は個別のコミットとして作成される
- **返信形式**: 質問への返信は簡潔かつ技術的に正確な内容にする
- **対応不可の場合**: 技術的に対応が困難なコメントは、理由を説明するコメントを投稿
